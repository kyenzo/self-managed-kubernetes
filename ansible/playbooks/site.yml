---
# Main playbook for complete cluster setup

- name: Prepare all nodes
  hosts: k8s_cluster
  become: yes
  roles:
    - common
    - container-runtime
    - kubernetes

- name: Initialize primary control plane
  hosts: primary_control_plane
  become: yes
  roles:
    - control-plane

- name: Join additional control plane nodes
  hosts: control_plane:!primary_control_plane
  become: yes
  serial: 1
  tasks:
    - name: Check if already joined
      stat:
        path: /etc/kubernetes/admin.conf
      register: cp_joined

    - name: Get join command and certificate key from primary
      set_fact:
        join_cmd: "{{ hostvars[groups['primary_control_plane'][0]]['kubeadm_join_command'] }}"
        cert_key: "{{ hostvars[groups['primary_control_plane'][0]]['certificate_key'] | default('') }}"
      when: not cp_joined.stat.exists

    - name: Join as control plane node
      command: "{{ join_cmd }} --control-plane --certificate-key {{ cert_key }}"
      when:
        - not cp_joined.stat.exists
        - cert_key != ''

    - name: Create .kube directory
      file:
        path: "/home/{{ kubectl_user }}/.kube"
        state: directory
        owner: "{{ kubectl_user }}"
        group: "{{ kubectl_user }}"
        mode: '0755'

    - name: Copy admin.conf
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ kubectl_user }}/.kube/config"
        remote_src: yes
        owner: "{{ kubectl_user }}"
        group: "{{ kubectl_user }}"
        mode: '0600'

- name: Join worker nodes
  hosts: workers
  become: yes
  roles:
    - worker

- name: Verify cluster
  hosts: primary_control_plane
  become: yes
  become_user: "{{ kubectl_user }}"
  tasks:
    - name: Wait for all nodes to be ready
      shell: kubectl get nodes --no-headers | grep -v "NotReady" | wc -l
      register: ready_nodes
      until: ready_nodes.stdout | int == groups['k8s_cluster'] | length
      retries: 30
      delay: 10
      changed_when: false

    - name: Display cluster nodes
      command: kubectl get nodes -o wide
      register: cluster_nodes
      changed_when: false

    - name: Show cluster status
      debug:
        msg: "{{ cluster_nodes.stdout_lines }}"
